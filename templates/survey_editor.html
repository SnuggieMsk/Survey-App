{% extends "base.html" %}

{% block title %}Edit Survey - {{ survey.title }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>{{ survey.title }}</h1>
        <p class="lead">{{ survey.description }}</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group">
            <a href="{{ url_for('survey_settings', survey_id=survey.id) }}" class="btn btn-outline-primary">
                <i class="fas fa-cog"></i> Settings
            </a>
            <a href="{{ url_for('view_survey', survey_id=survey.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-eye"></i> Preview
            </a>
            <a href="{{ url_for('view_responses', survey_id=survey.id) }}" class="btn btn-outline-success">
                <i class="fas fa-chart-bar"></i> Responses
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Question list -->
        <div id="question-container">
            {% if questions %}
                {% for question in questions %}
                    <div class="card question-card mb-3" data-question-id="{{ question.id }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-grip-lines me-2 question-handle"></i>
                                <h5 class="mb-0">Question {{ loop.index }}</h5>
                            </div>
                            <div class="question-toolbar">
                                <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-question">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-delete-question">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="question-preview mb-3">
                                <div class="question-text mb-2">
                                    {{ question.question_text }}
                                    {% if question.required %}
                                        <span class="badge bg-primary ms-2">Required</span>
                                    {% endif %}
                                </div>
                                
                                {% if question.image_path %}
                                    <div class="question-image mb-3">
                                        <img src="{{ question.image_path }}" alt="Question image" class="img-fluid rounded" style="max-height: 150px;">
                                    </div>
                                {% endif %}
                                
                                <div class="question-type-label">
                                    <span class="badge bg-secondary">
                                        {% if question.question_type == 'multiple-choice' %}
                                            Multiple Choice
                                        {% elif question.question_type == 'image-choice' %}
                                            Image Choice
                                        {% elif question.question_type == 'rating' %}
                                            Rating Scale
                                        {% elif question.question_type == 'slider' %}
                                            Slider
                                        {% elif question.question_type == 'text' %}
                                            Text Input
                                        {% endif %}
                                    </span>
                                </div>
                                
                                {% if question.question_type == 'multiple-choice' or question.question_type == 'image-choice' %}
                                    <div class="options-preview mt-3">
                                        <div class="options-container">
                                            {% for option in question.options %}
                                                <div class="option-item d-flex align-items-center mb-2" data-option-id="{{ option.id }}">
                                                    <i class="fas fa-circle me-2" style="font-size: 10px;"></i>
                                                    <div class="option-text">{{ option.option_text }}</div>
                                                    {% if option.image_path %}
                                                        <img src="{{ option.image_path }}" alt="Option image" class="ms-2 img-fluid rounded" style="max-height: 30px;">
                                                    {% endif %}
                                                    <div class="ms-auto">
                                                        <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-option">
                                                            <i class="fas fa-pencil-alt"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger btn-delete-option">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary mt-2 btn-add-option">
                                            <i class="fas fa-plus"></i> Add Option
                                        </button>
                                    </div>
                                {% elif question.question_type == 'rating' %}
                                    <div class="rating-preview mt-3">
                                        <div class="d-flex justify-content-center stars">
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                        </div>
                                    </div>
                                {% elif question.question_type == 'slider' %}
                                    <div class="slider-preview mt-3">
                                        <div class="range-value text-center">5</div>
                                        <input type="range" class="form-range" min="0" max="10" value="5" disabled>
                                        <div class="d-flex justify-content-between">
                                            <small>0</small>
                                            <small>10</small>
                                        </div>
                                    </div>
                                {% elif question.question_type == 'text' %}
                                    <div class="text-preview mt-3">
                                        <textarea class="form-control" rows="2" placeholder="Text answer" disabled></textarea>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No questions added yet. Use the panel on the right to add questions.
                </div>
            {% endif %}
        </div>
        
        <!-- Publishing status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Survey Status</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-0">
                            {% if survey.published %}
                                <span class="badge bg-success">Published</span> This survey is live and accepting responses.
                            {% else %}
                                <span class="badge bg-warning text-dark">Draft</span> This survey is not published yet.
                            {% endif %}
                        </p>
                    </div>
                    <form action="{{ url_for('toggle_publish_survey', survey_id=survey.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-sm {% if survey.published %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
                            {% if survey.published %}
                                <i class="fas fa-eye-slash"></i> Unpublish
                            {% else %}
                                <i class="fas fa-check-circle"></i> Publish
                            {% endif %}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Add question panel -->
        <div class="card sticky-top" style="top: 20px; z-index: 100;">
            <div class="card-header">
                <h5 class="mb-0">Add Question</h5>
            </div>
            <div class="card-body">
                <form id="add-question-form">
                    <div class="mb-3">
                        <label for="question-text" class="form-label">Question Text</label>
                        <textarea id="question-text" class="form-control" rows="2" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="question-type" class="form-label">Question Type</label>
                        <select id="question-type" class="form-select">
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="rating">Rating Scale</option>
                            <option value="slider">Slider</option>
                            <option value="text">Text Input</option>
                            <option value="image-choice">Image Choice</option>
                        </select>
                    </div>
                    
                    <div id="options-container" class="mb-3">
                        <label class="form-label">Options</label>
                        <div id="options-list">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control option-input" placeholder="Option 1">
                                <button type="button" class="btn btn-outline-danger remove-option">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control option-input" placeholder="Option 2">
                                <button type="button" class="btn btn-outline-danger remove-option">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" id="add-option" class="btn btn-sm btn-outline-secondary mt-1">
                            <i class="fas fa-plus"></i> Add Option
                        </button>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="question-required">
                        <label class="form-check-label" for="question-required">
                            Required question
                        </label>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i> Add Question
                        </button>
                    </div>
                </form>
                
                <hr class="my-3">
                
                <div class="d-grid gap-2">
                    <button type="button" id="generate-questions-btn" class="btn btn-outline-secondary">
                        <i class="fas fa-magic"></i> Generate Questions
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Question Modal -->
<div class="modal fade" id="editQuestionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-question-form">
                    <input type="hidden" id="edit-question-id">
                    <div class="mb-3">
                        <label for="edit-question-text" class="form-label">Question Text</label>
                        <textarea id="edit-question-text" class="form-control" rows="2" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-question-type" class="form-label">Question Type</label>
                        <select id="edit-question-type" class="form-select">
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="rating">Rating Scale</option>
                            <option value="slider">Slider</option>
                            <option value="text">Text Input</option>
                            <option value="image-choice">Image Choice</option>
                        </select>
                    </div>
                    
                    <div id="edit-options-container" class="mb-3">
                        <label class="form-label">Options</label>
                        <div id="edit-options-list">
                            <!-- Options will be added dynamically -->
                        </div>
                        <button type="button" id="edit-add-option" class="btn btn-sm btn-outline-secondary mt-1">
                            <i class="fas fa-plus"></i> Add Option
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label for="question-image" class="form-label">Question Image</label>
                        <div id="question-image-preview" class="mb-2 d-none">
                            <img id="question-image-preview-img" src="#" alt="Question image" class="img-fluid rounded" style="max-height: 150px;">
                        </div>
                        <input type="file" class="form-control" id="question-image" accept="image/*" data-preview="question-image-preview-img">
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="edit-question-required">
                        <label class="form-check-label" for="edit-question-required">
                            Required question
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-question">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Option Modal -->
<div class="modal fade" id="editOptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Option</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-option-form">
                    <input type="hidden" id="edit-option-id">
                    <div class="mb-3">
                        <label for="edit-option-text" class="form-label">Option Text</label>
                        <input type="text" id="edit-option-text" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="option-image" class="form-label">Option Image</label>
                        <div id="option-image-preview" class="mb-2 d-none">
                            <img id="option-image-preview-img" src="#" alt="Option image" class="img-fluid rounded" style="max-height: 100px;">
                        </div>
                        <input type="file" class="form-control" id="option-image" accept="image/*" data-preview="option-image-preview-img">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-option">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Questions Modal -->
<div class="modal fade" id="generateQuestionsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Questions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="generate-questions-form">
                    <div class="mb-3">
                        <label for="topic" class="form-label">Topic</label>
                        <input type="text" id="topic" class="form-control" placeholder="E.g., customer satisfaction, product feedback" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="num-questions" class="form-label">Number of Questions</label>
                        <input type="number" id="num-questions" class="form-control" min="1" max="10" value="5">
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="include-visuals" checked>
                        <label class="form-check-label" for="include-visuals">
                            Include visual element suggestions
                        </label>
                    </div>
                </form>
                
                <div id="generate-loading" class="text-center py-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating questions...</p>
                </div>
                
                <div id="generated-questions-container" class="d-none">
                    <h6>Generated Questions:</h6>
                    <div id="generated-questions-list" class="list-group mb-3">
                        <!-- Generated questions will be inserted here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="start-generate">Generate</button>
                <button type="button" class="btn btn-success d-none" id="add-generated-questions">Add Selected Questions</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Question type change handler
        const questionTypeSelect = document.getElementById('question-type');
        const optionsContainer = document.getElementById('options-container');
        
        questionTypeSelect.addEventListener('change', function() {
            if (this.value === 'multiple-choice' || this.value === 'image-choice') {
                optionsContainer.classList.remove('d-none');
            } else {
                optionsContainer.classList.add('d-none');
            }
        });
        
        // Add option button
        document.getElementById('add-option').addEventListener('click', function() {
            const optionsList = document.getElementById('options-list');
            const optionCount = optionsList.querySelectorAll('.option-input').length;
            
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group mb-2';
            inputGroup.innerHTML = `
                <input type="text" class="form-control option-input" placeholder="Option ${optionCount + 1}">
                <button type="button" class="btn btn-outline-danger remove-option">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            optionsList.appendChild(inputGroup);
            
            // Add event listener to the new remove button
            inputGroup.querySelector('.remove-option').addEventListener('click', function() {
                this.closest('.input-group').remove();
            });
        });
        
        // Remove option buttons
        document.querySelectorAll('.remove-option').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.input-group').remove();
            });
        });
        
        // Add question form
        document.getElementById('add-question-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const questionText = document.getElementById('question-text').value;
            const questionType = document.getElementById('question-type').value;
            const required = document.getElementById('question-required').checked;
            
            let options = [];
            if (questionType === 'multiple-choice' || questionType === 'image-choice') {
                document.querySelectorAll('.option-input').forEach(input => {
                    if (input.value.trim()) {
                        options.push(input.value.trim());
                    }
                });
                
                if (options.length < 2) {
                    alert('Please add at least two options.');
                    return;
                }
            }
            
            // Send question data to server
            fetch('/api/survey/{{ survey.id }}/questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    question_text: questionText,
                    question_type: questionType,
                    required: required,
                    options: options
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    // Refresh the page to show the new question
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to add question. Please try again.');
            });
        });
        
        // Edit question buttons
        document.querySelectorAll('.btn-edit-question').forEach(button => {
            button.addEventListener('click', function() {
                const questionCard = this.closest('.question-card');
                const questionId = questionCard.dataset.questionId;
                
                // Populate modal with question data
                document.getElementById('edit-question-id').value = questionId;
                document.getElementById('edit-question-text').value = questionCard.querySelector('.question-text').textContent.trim();
                
                // Get question type
                const typeLabel = questionCard.querySelector('.question-type-label .badge').textContent.trim();
                let questionType;
                
                if (typeLabel === 'Multiple Choice') questionType = 'multiple-choice';
                else if (typeLabel === 'Image Choice') questionType = 'image-choice';
                else if (typeLabel === 'Rating Scale') questionType = 'rating';
                else if (typeLabel === 'Slider') questionType = 'slider';
                else if (typeLabel === 'Text Input') questionType = 'text';
                
                document.getElementById('edit-question-type').value = questionType;
                
                // Check if required
                const isRequired = questionCard.querySelector('.badge.bg-primary') !== null;
                document.getElementById('edit-question-required').checked = isRequired;
                
                // Handle options
                const editOptionsList = document.getElementById('edit-options-list');
                editOptionsList.innerHTML = '';
                
                if (questionType === 'multiple-choice' || questionType === 'image-choice') {
                    questionCard.querySelectorAll('.option-item').forEach(option => {
                        const optionId = option.dataset.optionId;
                        const optionText = option.querySelector('.option-text').textContent;
                        
                        const optionHtml = `
                            <div class="input-group mb-2" data-option-id="${optionId}">
                                <input type="text" class="form-control edit-option-input" value="${optionText}">
                                <button type="button" class="btn btn-outline-secondary edit-option-btn">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger delete-option-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                        
                        editOptionsList.insertAdjacentHTML('beforeend', optionHtml);
                    });
                    
                    document.getElementById('edit-options-container').classList.remove('d-none');
                } else {
                    document.getElementById('edit-options-container').classList.add('d-none');
                }
                
                // Show modal
                const editQuestionModal = new bootstrap.Modal(document.getElementById('editQuestionModal'));
                editQuestionModal.show();
            });
        });
        
        // Question type change handler in edit modal
        const editQuestionTypeSelect = document.getElementById('edit-question-type');
        const editOptionsContainer = document.getElementById('edit-options-container');
        
        editQuestionTypeSelect.addEventListener('change', function() {
            if (this.value === 'multiple-choice' || this.value === 'image-choice') {
                editOptionsContainer.classList.remove('d-none');
            } else {
                editOptionsContainer.classList.add('d-none');
            }
        });
        
        // Add option in edit modal
        document.getElementById('edit-add-option').addEventListener('click', function() {
            const optionsList = document.getElementById('edit-options-list');
            
            const optionHtml = `
                <div class="input-group mb-2" data-option-id="new">
                    <input type="text" class="form-control edit-option-input" value="">
                    <button type="button" class="btn btn-outline-danger delete-option-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            optionsList.insertAdjacentHTML('beforeend', optionHtml);
        });
        
        // Edit option button event delegation
        document.getElementById('edit-options-list').addEventListener('click', function(e) {
            // Delete option button
            if (e.target.closest('.delete-option-btn')) {
                const optionItem = e.target.closest('.input-group');
                const optionId = optionItem.dataset.optionId;
                
                if (optionId !== 'new') {
                    if (confirm('Are you sure you want to delete this option?')) {
                        // Delete option from server
                        fetch(`/api/option/${optionId}`, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token() }}'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert('Error: ' + data.error);
                            } else {
                                optionItem.remove();
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Failed to delete option. Please try again.');
                        });
                    }
                } else {
                    optionItem.remove();
                }
            }
            
            // Edit option button
            if (e.target.closest('.edit-option-btn')) {
                const optionItem = e.target.closest('.input-group');
                const optionId = optionItem.dataset.optionId;
                
                if (optionId !== 'new') {
                    const optionText = optionItem.querySelector('.edit-option-input').value;
                    document.getElementById('edit-option-id').value = optionId;
                    document.getElementById('edit-option-text').value = optionText;
                    
                    const editOptionModal = new bootstrap.Modal(document.getElementById('editOptionModal'));
                    editOptionModal.show();
                }
            }
        });
        
        // Save edited option
        document.getElementById('save-option').addEventListener('click', function() {
            const optionId = document.getElementById('edit-option-id').value;
            const optionText = document.getElementById('edit-option-text').value;
            
            // Update option on server
            fetch(`/api/option/${optionId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    option_text: optionText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    // Upload image if selected
                    const optionImage = document.getElementById('option-image').files[0];
                    if (optionImage) {
                        const formData = new FormData();
                        formData.append('image', optionImage);
                        
                        fetch(`/api/option/${optionId}/image`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token() }}'
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(imageData => {
                            if (imageData.error) {
                                alert('Error uploading image: ' + imageData.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error uploading image:', error);
                        });
                    }
                    
                    // Close modal and refresh
                    bootstrap.Modal.getInstance(document.getElementById('editOptionModal')).hide();
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update option. Please try again.');
            });
        });
        
        // Save edited question
        document.getElementById('save-question').addEventListener('click', function() {
            const questionId = document.getElementById('edit-question-id').value;
            const questionText = document.getElementById('edit-question-text').value;
            const questionType = document.getElementById('edit-question-type').value;
            const required = document.getElementById('edit-question-required').checked;
            
            // Update question on server
            fetch(`/api/question/${questionId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    question_text: questionText,
                    question_type: questionType,
                    required: required
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    // Upload image if selected
                    const questionImage = document.getElementById('question-image').files[0];
                    if (questionImage) {
                        const formData = new FormData();
                        formData.append('image', questionImage);
                        
                        fetch(`/api/question/${questionId}/image`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token() }}'
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(imageData => {
                            if (imageData.error) {
                                alert('Error uploading image: ' + imageData.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error uploading image:', error);
                        });
                    }
                    
                    // Process edited options
                    const optionsContainer = document.getElementById('edit-options-list');
                    const optionItems = optionsContainer.querySelectorAll('.input-group');
                    
                    if (questionType === 'multiple-choice' || questionType === 'image-choice') {
                        optionItems.forEach(item => {
                            const optionId = item.dataset.optionId;
                            const optionText = item.querySelector('.edit-option-input').value;
                            
                            if (optionId === 'new') {
                                // Add new option
                                fetch(`/api/question/${questionId}/options`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': '{{ csrf_token() }}'
                                    },
                                    body: JSON.stringify({
                                        option_text: optionText
                                    })
                                })
                                .then(response => response.json())
                                .catch(error => {
                                    console.error('Error adding option:', error);
                                });
                            } else {
                                // Update existing option
                                fetch(`/api/option/${optionId}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': '{{ csrf_token() }}'
                                    },
                                    body: JSON.stringify({
                                        option_text: optionText
                                    })
                                })
                                .then(response => response.json())
                                .catch(error => {
                                    console.error('Error updating option:', error);
                                });
                            }
                        });
                    }
                    
                    // Close modal and refresh
                    bootstrap.Modal.getInstance(document.getElementById('editQuestionModal')).hide();
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update question. Please try again.');
            });
        });
        
        // Delete question buttons
        document.querySelectorAll('.btn-delete-question').forEach(button => {
            button.addEventListener('click', function() {
                const questionCard = this.closest('.question-card');
                const questionId = questionCard.dataset.questionId;
                
                if (confirm('Are you sure you want to delete this question?')) {
                    // Delete question from server
                    fetch(`/api/question/${questionId}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token() }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                        } else {
                            // Remove question card and refresh
                            window.location.reload();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete question. Please try again.');
                    });
                }
            });
        });
        
        // Add option to existing question
        document.querySelectorAll('.btn-add-option').forEach(button => {
            button.addEventListener('click', function() {
                const questionCard = this.closest('.question-card');
                const questionId = questionCard.dataset.questionId;
                
                const optionText = prompt('Enter option text:');
                if (optionText && optionText.trim()) {
                    // Add option to server
                    fetch(`/api/question/${questionId}/options`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({
                            option_text: optionText.trim()
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                        } else {
                            // Refresh page to show new option
                            window.location.reload();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to add option. Please try again.');
                    });
                }
            });
        });
        
        // Edit option in preview
        document.querySelectorAll('.btn-edit-option').forEach(button => {
            button.addEventListener('click', function() {
                const optionItem = this.closest('.option-item');
                const optionId = optionItem.dataset.optionId;
                const optionText = optionItem.querySelector('.option-text').textContent;
                
                document.getElementById('edit-option-id').value = optionId;
                document.getElementById('edit-option-text').value = optionText;
                
                const editOptionModal = new bootstrap.Modal(document.getElementById('editOptionModal'));
                editOptionModal.show();
            });
        });
        
        // Delete option in preview
        document.querySelectorAll('.btn-delete-option').forEach(button => {
            button.addEventListener('click', function() {
                const optionItem = this.closest('.option-item');
                const optionId = optionItem.dataset.optionId;
                
                if (confirm('Are you sure you want to delete this option?')) {
                    // Delete option from server
                    fetch(`/api/option/${optionId}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token() }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                        } else {
                            // Remove option item and refresh
                            window.location.reload();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete option. Please try again.');
                    });
                }
            });
        });
        
        // Generate questions button
        document.getElementById('generate-questions-btn').addEventListener('click', function() {
            const generateQuestionsModal = new bootstrap.Modal(document.getElementById('generateQuestionsModal'));
            generateQuestionsModal.show();
        });
        
        // Start generation button
        document.getElementById('start-generate').addEventListener('click', function() {
            const topic = document.getElementById('topic').value;
            const numQuestions = document.getElementById('num-questions').value;
            const includeVisuals = document.getElementById('include-visuals').checked;
            
            if (!topic) {
                alert('Please enter a topic.');
                return;
            }
            
            // Show loading state
            document.getElementById('generate-loading').classList.remove('d-none');
            document.getElementById('generated-questions-container').classList.add('d-none');
            document.getElementById('start-generate').classList.add('d-none');
            document.getElementById('add-generated-questions').classList.add('d-none');
            
            // Call API to generate questions
            fetch('/api/generate-questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    topic: topic,
                    num_questions: parseInt(numQuestions),
                    include_visuals: includeVisuals
                })
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading state
                document.getElementById('generate-loading').classList.add('d-none');
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    document.getElementById('start-generate').classList.remove('d-none');
                } else {
                    // Show generated questions
                    const questionsContainer = document.getElementById('generated-questions-list');
                    questionsContainer.innerHTML = '';
                    
                    if (data.questions && data.questions.length > 0) {
                        data.questions.forEach((question, index) => {
                            const questionHtml = `
                                <div class="list-group-item">
                                    <div class="form-check">
                                        <input class="form-check-input generated-question-check" type="checkbox" value="${index}" id="generated-question-${index}" checked>
                                        <label class="form-check-label" for="generated-question-${index}">
                                            <strong>${question.question_text}</strong>
                                            <span class="badge bg-secondary ms-2">${question.question_type}</span>
                                        </label>
                                    </div>
                                    ${question.options && question.options.length > 0 ? 
                                        `<div class="ms-4 mt-2">
                                            <small class="text-muted">Options:</small>
                                            <ul class="mb-0 small">
                                                ${question.options.map(opt => `<li>${opt}</li>`).join('')}
                                            </ul>
                                        </div>` 
                                    : ''}
                                    ${question.suggested_image ? 
                                        `<div class="ms-4 mt-1">
                                            <small class="text-muted">Suggested image: ${question.suggested_image}</small>
                                        </div>` 
                                    : ''}
                                </div>
                            `;
                            
                            questionsContainer.insertAdjacentHTML('beforeend', questionHtml);
                        });
                        
                        // Store questions data
                        document.getElementById('generated-questions-container').dataset.questions = JSON.stringify(data.questions);
                        
                        // Show questions and add button
                        document.getElementById('generated-questions-container').classList.remove('d-none');
                        document.getElementById('add-generated-questions').classList.remove('d-none');
                    } else {
                        questionsContainer.innerHTML = '<div class="alert alert-warning">No questions were generated. Please try a different topic.</div>';
                        document.getElementById('generated-questions-container').classList.remove('d-none');
                        document.getElementById('start-generate').classList.remove('d-none');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('generate-loading').classList.add('d-none');
                document.getElementById('start-generate').classList.remove('d-none');
                alert('Failed to generate questions. Please try again.');
            });
        });
        
        // Add generated questions
        document.getElementById('add-generated-questions').addEventListener('click', function() {
            const questionsData = JSON.parse(document.getElementById('generated-questions-container').dataset.questions);
            const selectedQuestions = [];
            
            // Get selected questions
            document.querySelectorAll('.generated-question-check:checked').forEach(checkbox => {
                const index = parseInt(checkbox.value);
                if (!isNaN(index) && index >= 0 && index < questionsData.length) {
                    selectedQuestions.push(questionsData[index]);
                }
            });
            
            if (selectedQuestions.length === 0) {
                alert('Please select at least one question.');
                return;
            }
            
            // Add selected questions one by one
            let addedCount = 0;
            
            const addNextQuestion = (index) => {
                if (index >= selectedQuestions.length) {
                    // All questions added, refresh page
                    window.location.reload();
                    return;
                }
                
                const question = selectedQuestions[index];
                
                fetch('/api/survey/{{ survey.id }}/questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({
                        question_text: question.question_text,
                        question_type: question.question_type,
                        required: false,
                        options: question.options || []
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        addedCount++;
                    }
                    
                    // Add next question
                    addNextQuestion(index + 1);
                })
                .catch(error => {
                    console.error('Error adding question:', error);
                    // Continue with next question
                    addNextQuestion(index + 1);
                });
            };
            
            // Start adding questions
            addNextQuestion(0);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('generateQuestionsModal')).hide();
        });
    });
</script>
{% endblock %}
